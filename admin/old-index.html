<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <title>管理後台 | Image Description Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex" />
    <style>
      body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; background:#f6f7f9; }
      .wrap { max-width: 560px; margin: 8vh auto; padding: 24px; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); background:#fff; }
      h1 { margin: 0 0 8px; font-size: 20px; }
      p { color: #4b5563; line-height: 1.6; }
      .field { margin-top: 16px; }
      input[type="password"] { width: 100%; font-size: 16px; padding: 12px 14px; border: 1px solid #d1d5db; border-radius: 8px; }
      button { margin-top: 16px; padding: 10px 14px; border: 0; border-radius: 8px; background: #111827; color: #fff; font-weight: 600; cursor: pointer; }
      .hint { font-size: 13px; color: #6b7280; margin-top: 6px; }
      .danger { color: #b91c1c; }
      .footer { margin-top: 16px; display: flex; gap: 8px; justify-content: space-between; align-items: center; }
      .link { color: #2563eb; text-decoration: none; }
      .link:hover { text-decoration: underline; }
      .err { color: #b91c1c; font-size: 14px; margin-top: 10px; display:none; }
      .note { font-size: 13px; color: #374151; margin-top: 12px; background: #f9fafb; padding: 10px 12px; border-radius: 8px; border: 1px solid #e5e7eb; }
    </style>

    <!-- Manual init: prevent Decap from auto OAuth init -->
    <script>
      window.CMS_MANUAL_INIT = true;
    </script>
  </head>
  <body>
    <div id="token-login" class="wrap" role="dialog" aria-labelledby="title" aria-describedby="desc">
      <h1 id="title">登入後台（以 GitHub PAT）</h1>
      <p id="desc">
        貼上你的 GitHub Personal Access Token（建議 Fine‑grained PAT，僅授權此倉庫，權限：Contents 與 Pull requests）。
        Token 只會暫存於本分頁的 sessionStorage，關閉分頁即清除。
      </p>
      <div class="field">
        <label for="token" class="hint">GitHub PAT</label>
        <input id="token" type="password" autocomplete="off" placeholder="ghp_xxx 或 github_pat_xxx" />
        <div class="hint danger">請勿將 Token 寫入程式碼或提交到版本庫</div>
        <div id="err" class="err"></div>
      </div>
      <button id="submit">使用 Token 登入</button>
      <div class="note">
        若你看到「使用你的 GitHub 帳號登入」的 OAuth 畫面，請確認你是從
        <a class="link" href="https://tonyonier99.github.io/Image-description-generator/admin/" target="_blank" rel="noopener">這個網址</a>
        開啟，並按下 Ctrl/Cmd+Shift+R 強制重整清除快取。
      </div>
      <div class="footer">
        <a class="link" href="https://github.com/settings/tokens?type=beta" target="_blank" rel="noopener">建立 Fine‑grained PAT</a>
        <a class="link" href="https://github.com/settings/tokens" target="_blank" rel="noopener">或建立 classic PAT（repo scope）</a>
      </div>
    </div>

    <!-- Pin version to avoid CDN auto-upgrades changing behavior -->
    <script src="https://unpkg.com/decap-cms@3.0.0/dist/decap-cms.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script>
      (function () {
        const KEY = "decap:github_token";
        const repo = "tonyonier99/Image-description-generator";
        const branch = "main";

        function el(id){ return document.getElementById(id); }
        function showError(msg){ const e = el("err"); if (!e) return; e.textContent = msg; e.style.display = "block"; }
        function clearError(){ const e = el("err"); if (!e) return; e.textContent = ""; e.style.display = "none"; }

        async function verifyToken(token){
          const headers = {
            Authorization: `token ${token}`,
            Accept: "application/vnd.github+json",
            "X-GitHub-Api-Version": "2022-11-28"
          };
          const u = await fetch("https://api.github.com/user", { headers });
          if (!u.ok) throw new Error("Token 驗證失敗，請確認是否有效。");
          return true;
        }

        async function loadYamlConfig(){
          const res = await fetch("config.yml", { cache: "no-store" });
          if (!res.ok) throw new Error(`載入設定檔失敗（${res.status}）`);
          const text = await res.text();
          return window.jsyaml.load(text);
        }

        let started = false;
        async function startCMS(token) {
          if (started) return; // avoid double init
          started = true;

          const box = el("token-login");
          if (box) box.style.display = "none";

          let cfg = {};
          try {
            cfg = await loadYamlConfig();
          } catch (e) {
            console.error(e);
            showError((e && e.message) || "載入設定失敗");
            started = false; // allow retry
            return;
          }

          // Prevent Decap from reloading config.yml again
          cfg.load_config_file = false;

          // Inject backend at runtime with PAT
          cfg.backend = {
            name: "github",
            repo,
            branch,
            auth_type: "token",
            token,
            api_root: "https://api.github.com",
            use_graphql_api: false
          };

          // Defaults safeguard
          cfg.publish_mode = cfg.publish_mode || "editorial_workflow";
          cfg.locale = cfg.locale || "zh_Hant";

          window.CMS.init({ config: cfg });

          window.CMS.registerEventListener({
            name: "logout",
            handler: () => {
              sessionStorage.removeItem(KEY);
              location.reload();
            }
          });
        }

        async function loginWith(token) {
          if (!token) return;
          clearError();
          try {
            await verifyToken(token);
            sessionStorage.setItem(KEY, token);
            startCMS(token);
          } catch (err) {
            showError((err && err.message) || "登入失敗，請檢查 Token 是否正確並具備 Contents / Pull requests 權限。");
          }
        }

        // Auto-login in this tab if a token already exists
        (async () => {
          const saved = sessionStorage.getItem(KEY);
          if (saved) {
            try {
              await verifyToken(saved);
              startCMS(saved);
              return;
            } catch (e) {
              sessionStorage.removeItem(KEY);
              showError("先前的 Token 已無效，請重新登入。");
            }
          }
        })();

        const btn = document.getElementById("submit");
        btn?.addEventListener("click", () => {
          const t = (document.getElementById("token")?.value || "").trim();
          if (!t) { showError("請先輸入 Token"); return; }
          loginWith(t);
        });

        const input = document.getElementById("token");
        input?.addEventListener("keydown", (e) => {
          if (e.key === "Enter") btn?.click();
        });
      })();
    </script>
  </body>
</html>
