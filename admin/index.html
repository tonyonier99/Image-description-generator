<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <title>管理後台 | Image Description Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex" />
    <style>
      body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; }
      .wrap { max-width: 560px; margin: 8vh auto; padding: 24px; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
      h1 { margin: 0 0 8px; font-size: 20px; }
      p { color: #4b5563; line-height: 1.6; }
      .field { margin-top: 16px; }
      input[type="password"] { width: 100%; font-size: 16px; padding: 12px 14px; border: 1px solid #d1d5db; border-radius: 8px; }
      button { margin-top: 16px; padding: 10px 14px; border: 0; border-radius: 8px; background: #111827; color: #fff; font-weight: 600; cursor: pointer; }
      .hint { font-size: 13px; color: #6b7280; margin-top: 6px; }
      .danger { color: #b91c1c; }
      .footer { margin-top: 16px; display: flex; gap: 8px; justify-content: space-between; align-items: center; }
      .link { color: #2563eb; text-decoration: none; }
      .link:hover { text-decoration: underline; }
    </style>
  </head>
  <body>
    <div id="token-login" class="wrap" role="dialog" aria-labelledby="title" aria-describedby="desc">
      <h1 id="title">登入後台（以 GitHub PAT）</h1>
      <p id="desc">
        請貼上你的 GitHub Personal Access Token（建議使用 Fine-grained PAT，僅授權此倉庫，權限：Contents 與 Pull requests）。
        Token 只會暫存於本分頁的 sessionStorage，關閉分頁即清除。
      </p>
      <div class="field">
        <label for="token" class="hint">GitHub PAT</label>
        <input id="token" type="password" autocomplete="off" placeholder="ghp_xxx 或 github_pat_xxx" />
        <div class="hint danger">請勿將 Token 寫入程式碼或提交到版本庫</div>
      </div>
      <button id="submit">使用 Token 登入</button>
      <div class="footer">
        <a class="link" href="https://github.com/settings/tokens?type=beta" target="_blank" rel="noopener">建立 Fine-grained PAT</a>
        <a class="link" href="https://github.com/settings/tokens" target="_blank" rel="noopener">或建立 classic PAT（repo scope）</a>
      </div>
    </div>

    <script>
      // 手動初始化 Decap CMS
      window.CMS_MANUAL_INIT = true;
    </script>
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script>
      (function () {
        const KEY = "decap:github_token";
        const repo = "tonyonier99/Image-description-generator";
        const branch = "main";

        function startCMS(token) {
          // 隱藏登入框
          const box = document.getElementById("token-login");
          if (box) box.style.display = "none";

          // 啟動 CMS：載入 config.yml，並以 token 覆寫 backend 設定
          window.CMS.init({
            config: {
              load_config_file: true,
              backend: {
                name: "github",
                repo,
                branch,
                token
              },
              publish_mode: "editorial_workflow",
              locale: "zh_Hant"
            }
          });

          // 供日後在 CMS 中做「登出」：清掉 token 後重新載入頁面
          window.CMS.registerEventListener({
            name: "logout",
            handler: () => {
              sessionStorage.removeItem(KEY);
              location.reload();
            }
          });
        }

        function loginWith(token) {
          if (!token) return;
          sessionStorage.setItem(KEY, token);
          startCMS(token);
        }

        // 若 sessionStorage 已有 token，直接進入 CMS
        const saved = sessionStorage.getItem(KEY);
        if (saved) startCMS(saved);

        // 綁定提交
        const btn = document.getElementById("submit");
        btn?.addEventListener("click", () => {
          const t = (document.getElementById("token")?.value || "").trim();
          if (!t) return;
          loginWith(t);
        });

        // Enter 送出
        const input = document.getElementById("token");
        input?.addEventListener("keydown", (e) => {
          if (e.key === "Enter") btn?.click();
        });
      })();
    </script>
  </body>
</html>
